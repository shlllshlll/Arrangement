"use strict";function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _construct(t,r,e){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(t,r,e){var n=[null];n.push.apply(n,r);var o=new(Function.bind.apply(t,n));return e&&_setPrototypeOf(o,e.prototype),o}).apply(null,arguments)}function _setPrototypeOf(t,r){return(_setPrototypeOf=Object.setPrototypeOf||function(t,r){return t.__proto__=r,t})(t,r)}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var r=0,e=new Array(t.length);r<t.length;r++)e[r]=t[r];return e}}define(["common","jquery","module.datatable","module.utils","datepicker","datepicker.zh-CN"],function(t,r,e,n){var o={},l=function(t){var e=!1;if(t instanceof Array||(t=[t]),0===t.length)return e;var n=!0,o=!1,l=void 0;try{for(var a,i=t[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){var c=a.value,u=r(c.dom),s=(0,c.checker)(u.val());s&&function(){var t=r('<p style="color: red;font-size: 0.9rem;">'+s+"</p>");u.click(function e(){r(this).removeClass("form-control-error"),r(this).unbind("click",e),t.remove()}),u.addClass("form-control-error"),u.after(t),e=!0}()}}catch(t){o=!0,l=t}finally{try{n||null==i.return||i.return()}finally{if(o)throw l}}return e},a=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},o=parseInt(r("#mytab li:last-child a").attr("aria-controls").replace(/[^0-9]/gi,""));r("#nextBtn").click(function(){var e=r(".nav-link.active").attr("aria-controls"),n=(e=parseInt(e.replace(/[^0-9]/gi,"")))>=o?e:e+1;t(e,n)||r("#mytab li:nth-child("+n+") a").tab("show")}),r("#backBtn").click(function(){var e=r(".nav-link.active").attr("aria-controls"),n=(e=parseInt(e.replace(/[^0-9]/gi,"")))>1?e-1:e;t(e,n)||r("#mytab li:nth-child("+n+") a").tab("show")}),r("#finishBtn").click(function(){e()}),r('a[data-toggle="tab"]').on("shown.bs.tab",function(t){var e=r(t.target).attr("aria-controls");1===(e=parseInt(e.replace(/[^0-9]/gi,"")))?r("#backBtn").addClass("disabled"):r("#backBtn").removeClass("disabled"),e===o?(r("#nextBtn").css("display","none"),r("#finishBtn").css("display","")):(r("#nextBtn").css("display",""),r("#finishBtn").css("display","none"))}),r('a[data-toggle="tab"]').on("shown.bs.tab",function(t){var e=r(t.target).attr("aria-controls");e=parseInt(e.replace(/[^0-9]/gi,""));var o=r(t.relatedTarget).attr("aria-controls");o=parseInt(o.replace(/[^0-9]/gi,"")),n(o,e),1===e&&(r("#title h3").text("排班周期选择"),r("#title p").text("请选择三线排班的周期"))})},i={init:function(){if(!o.userTable){o.userTable=new e("#userTable");var l=[{title:"姓名"},{title:"备注"},{title:"规则"},{name:"control",searchable:!1,title:"操作",orderable:!1,defaultContent:'<input type="button" value="❌" style="border-style: none;background: inherit;">',createdCell:function(t,e,l,a,i){r(t).on("click","input",{rowIndex:a,rowData:l},function(t){var r=t.data.rowIndex,e=t.data.rowData;n.showModal("delRowModal","警告","是否确定删除"+e[0]+"的数据",function(){o.userTable.table.row(r).remove().draw()},"okDelRowBtn")})}}];n.getJson({url:t.tlinedata},function(t){"String"==typeof t&&(t=JSON.parse(t)),o.userTable.createTable(t,{table:{searching:!1,ordering:!1,autoWidth:!0,paging:!1,columns:l}})})}r("#usrTableAddBtn").click(function(){n.showModal("addModal","排班规则设置","",function(){var t=r("#usrAddName").val(),e=r("#usrAddComment").val(),n={0:new Set,1:new Set};for(var l in r("#usrAddForm .ruleRow").each(function(){var t=r(this).find("select").val();r(this).find("input").val().split(" ").forEach(function(r){n[t].add(r)})}),n)n[l]=Array.from(n[l]);n=JSON.stringify(n);var a=o.userTable.table.columns().header().length-1,i=new Array(a).fill("");i[0]=t,i[1]=e,i[2]=n,o.userTable.table.row.add(i).draw()},"okAddBtn");r("#addModal .modal-body").append('<form id="usrAddForm"><div class="form-group row">\n                        <label class="col-form-label col-sm-3">姓名</label>\n                        <input type="text" class="form-control col-sm-7" id="usrAddName">\n                    </div>\n                    <div class="form-group row">\n                        <label class="col-form-label col-sm-3">备注</label>\n                        <input type="text" class="form-control col-sm-7" id="usrAddComment">\n                    </div>\n                    <div class="form-group row">\n                        <label class="col-form-label col-sm-3">规则</label>\n                    </div>\n                    <div class="form-group row d-flex justify-content-center" id="usrAddIcon">\n                        <i class="nc-icon nc-simple-add" style="font-size:25px;cursor:pointer;"></i></div>\n                    </form>'),r("#usrAddIcon").click(function(){r("#usrAddForm .row:nth-last-child(2)").after('<div class="form-group row align-items-center ruleRow">\n                    <i class="nc-icon nc-simple-delete col-sm-1" style="font-size:20px;cursor:pointer;padding-right:20px;"></i>\n                    <select class="form-control col-sm-3 custom-select">\n                        <option value=\'1\'>值</option>\n                        <option value=\'0\'>不值</option>\n                    </select>\n                    <input type="text" class="form-control col-sm-8">\n                </div>'),r("#usrAddForm .ruleRow i").click(function(){r(this).parent().remove()})})}),r("#usrTableDelBtn").click(function(){n.showModal("delModal","警告","是否确定删除数据",function(){o.userTable.updateData([]),n.postJson({url:t.tlinedata,data:JSON.stringify([])},function(){return t.showNotification("数据清楚成功","success")},function(){return t.showNotification("数据清楚失败","error")})},"okDelBtn")}),r("#usrTableSaveBtn").click(function(){i.postUserTable()})},postUserTable:function(){n.postJson({url:t.tlinedata,data:JSON.stringify(o.userTable.table.data().toArray())},function(){return t.showNotification("数据保存成功","success")},function(){return t.showNotification("数据保存失败","error")})}},c={init:function(){if(!o.preTable){o.preTable=new e("#preAranTable");var l=[{title:"姓名"},{title:"日期"},{name:"control",searchable:!1,title:"操作",orderable:!1,defaultContent:'<input type="button" value="❌" style="border-style: none;background: inherit;">',createdCell:function(t,e,l,a,i){r(t).on("click","input",{rowIndex:a,rowData:l},function(t){var r=t.data.rowIndex,e=t.data.rowData;n.showModal("delRowModal","警告","是否确定删除"+e[0]+"的数据",function(){o.preTable.table.row(r).remove().draw()},"okDelRowBtn")})}}];n.getJson({url:t.tlinePre},function(t){"String"==typeof t&&(t=JSON.parse(t)),o.preTable.createTable(t,{table:{searching:!1,ordering:!1,autoWidth:!0,paging:!1,columns:l}})})}r("#preTableAddBtn").click(function(){n.showModal("addModal","添加排班日期","",function(){var t=r("#usrAddName").val(),e=[];r("#usrAddForm .ruleRow").each(function(){var t=r(this).find("input").val();e.push(t)}),e=JSON.stringify(e);var n=o.preTable.table.columns().header().length-1,l=new Array(n).fill("");l[0]=t,l[1]=e,o.preTable.table.row.add(l).draw()},"okAddBtn");var t='<div class="form-group row align-items-center ruleRow">\n                    <i class="nc-icon nc-simple-delete col-sm-1" style="font-size:20px;cursor:pointer;padding-right:20px;"></i>\n                    <div class="col-sm-1"></div>\n                    <input id="addDatePicker" class="form-control col-sm-8">\n                </div>';r("#addModal .modal-body").append('<form id="usrAddForm"><div class="form-group row">\n                        <label class="col-form-label col-sm-3">姓名</label>\n                        <input type="text" class="form-control col-sm-7" id="usrAddName">\n                    </div>\n                    <div class="form-group row">\n                        <label class="col-form-label col-sm-3">值班日期</label>\n                    </div>\n                    <div class="form-group row d-flex justify-content-center" id="usrAddIcon">\n                        <i class="nc-icon nc-simple-add" style="font-size:25px;cursor:pointer;"></i></div>\n                    </form>'),r("#usrAddForm .row:nth-last-child(2)").after(t),r("#usrAddIcon").click(function(){r("#usrAddForm .row:nth-last-child(2)").after(t),r("#usrAddForm .ruleRow i").click(function(){r(this).parent().remove()})})}),r("#preTableDelBtn").click(function(){n.showModal("delModal","警告","是否确定删除数据",function(){o.preTable.updateData([]),n.postJson({url:t.tlinePre,data:JSON.stringify([])},function(){return t.showNotification("数据清楚成功","success")},function(){return t.showNotification("数据清楚失败","error")})},"okDelBtn")}),r("#preTableSaveBtn").click(function(){c.postTable()})},postTable:function(){n.postJson({url:t.tlinePre,data:JSON.stringify(o.preTable.table.data().toArray())},function(){return t.showNotification("数据保存成功","success")},function(){return t.showNotification("数据保存失败","error")})}},u=function(t,r){var e={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var n in/(y+)/.test(r)&&(r=r.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length))),e)new RegExp("("+n+")").test(r)&&(r=r.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return r},s=function(t,r){for(var e=[],n=t,o=function(t){var r=new Date(this.valueOf());return r.setDate(r.getDate()+1),r};n<=r;)e.push(n),n=o.call(n,1);return e},d=function(){if(!o.resultTable){o.resultTable=new e("#resultTable");o.resultTable.createTable([],{table:{autoWidth:!0,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"三线排班表",title:null}],columns:[{title:"日期"},{title:"姓名"},{title:"值班次数"}]}})}var t=o.startDate.split("/").map(function(t){return parseInt(t)});t.push(1);var r=o.endDate.split("/").map(function(t){return parseInt(t)});r.push(0),t[1]--,t=_construct(Date,_toConsumableArray(t)),r=_construct(Date,_toConsumableArray(r));var n=s(t,r),l={};o.userTable.table.data().toArray().forEach(function(t){l[t[0]]={rule:JSON.parse(t[2]),date:[]}});var a=o.preTable.table.data().toArray();a.forEach(function(t){var r,e=[],n=JSON.parse(t[1]),o=!0,a=!1,i=void 0;try{for(var c,u=n[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var s=c.value.split(".").map(function(t){return parseInt(t)});s[0]=2e3+s[0]%100,s[1]--;var d=_construct(Date,_toConsumableArray(s));e.push(d)}}catch(t){a=!0,i=t}finally{try{o||null==u.return||u.return()}finally{if(a)throw i}}(r=l[t[0]].date).push.apply(r,e)});var i=Object.keys(l),c=Math.ceil(n.length/i.length),d=[],f=[];a.forEach(function(t){var r=JSON.parse(t[1]),e=!0,n=!1,o=void 0;try{for(var l,a=r[Symbol.iterator]();!(e=(l=a.next()).done);e=!0){var i=l.value;(i=i.split("."))[0]=2e3+i[0]%100,i[1]--,i=_construct(Date,_toConsumableArray(i)).valueOf(),d.push(i),f.push(t[0])}}catch(t){n=!0,o=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw o}}});var p=[],h=!0,v=!1,b=void 0;try{for(var g,y=n[Symbol.iterator]();!(h=(g=y.next()).done);h=!0){var m=g.value,w=d.indexOf(m.valueOf());if(-1===w)for(var x=JSON.parse(JSON.stringify(i)),T=0;T<x.length;T++){var A=x[T];if(I(m,l[A].rule)&&M(m,l[A].date,c)){p.push([u(m,"yy-MM-dd"),A]),l[A].date.push(m),i.push(i.splice(T,1)[0]);break}T+1===x.length&&(p.push([u(m,"yy-MM-dd"),x[0]]),l[x[0]].date.push(m),i.push(i.splice(0,1)[0]))}else p.push([u(m,"yy-MM-dd"),f[w]])}}catch(t){v=!0,b=t}finally{try{h||null==y.return||y.return()}finally{if(v)throw b}}var k=[];function M(t,r,e){var n=!0,o=!1,l=void 0;try{for(var a,i=r[Symbol.iterator]();!(n=(a=i.next()).done);n=!0){var c=a.value;if(Math.abs(Math.round((t-c)/864e5))<10)return!1}}catch(t){o=!0,l=t}finally{try{n||null==i.return||i.return()}finally{if(o)throw l}}return!(r.length>=e)}function I(t,r){function e(t,r){return 1===r.split("-").length?function(t,r){if(1===r.length&&parseInt(r)<=7){var e=t.getDay();return(e=e||7)===parseInt(r)}var n=r.split(".");3===(n=n.map(function(t){return parseInt(t)})).length&&(n[0]%=100);for(var o=[t.getDate(),t.getMonth()+1,t.getFullYear()%100],l=!0,a=n.pop();a;)o.splice(0,1)[0]!==a&&(l=!1),a=n.pop();return!!l}(t,r):function(t,r){var e=r.split("-");if(1===e[0].length){var n=t.getDay();n=n||7;var o=parseInt(e[0]),l=parseInt(e[1]);return n>=o&&n<=l}var a=e[0].split("."),i=e[1].split(".");if(1===a.length&&1===i.length){var c=t.getDate(),u=parseInt(a[0]),s=parseInt(i[0]);return c>=u&&c<=s}if(2===a.length&&2===i.length){var d=t.getDate(),f=100*(t.getMonth()+1)+d,p=parseInt(e[0].replace(/\./g,"")),h=parseInt(e[1].replace(/\./g,""));return f>=p&&f<=h}if(3===a.length&&3===i.length){var v=t.getDate(),b=t.getMonth()+1,g=t.getFullYear()%100*1e4+100*b+v,y=parseInt(e[0].replace(/\./g,"")),m=parseInt(e[1].replace(/\./g,""));return g>=y&&g<=m}}(t,r)}var n=r[0];if(n.length){var o=!0,l=!1,a=void 0;try{for(var i,c=n[Symbol.iterator]();!(o=(i=c.next()).done);o=!0){if(e(t,i.value))return!1}}catch(t){l=!0,a=t}finally{try{o||null==c.return||c.return()}finally{if(l)throw a}}}var u=r[1];if(u.length){var s=!0,d=!1,f=void 0;try{for(var p,h=u[Symbol.iterator]();!(s=(p=h.next()).done);s=!0){if(e(t,p.value))return!0}}catch(t){d=!0,f=t}finally{try{s||null==h.return||h.return()}finally{if(d)throw f}}return!1}return!0}p.forEach(function(t){return k.push(t[1])}),p=p.map(function(t){var r,e;return t.push((r=k,e=t[1],r.reduce(function(t,r){return r===e?t+1:t},0))),t}),o.resultTable.updateData(p)},f={1:[{dom:"#startMonth",checker:function(t){return t?null:"日期不能为空"}},{dom:"#endMonth",checker:function(t){if(!t)return"日期不能为空";var e=parseInt(r("#startMonth").val().replace("/",""));return parseInt(t.replace("/",""))<e?"请确保结束日期小于开始日期":null}}],2:[],3:[],4:[]};r('[data-toggle="datepicker"]').datepicker({format:"yyyy/mm",language:"zh-CN"}),i.init(),c.init(),a(function(t){return l(f[t])},function(){r("#resultTable_wrapper button").click()},function(t,e){1===e?(r("#title h3").text("排班周期选择"),r("#title p").text("请选择三线排班的周期")):2===e?(r("#title h3").text("人员信息维护"),r("#title p").text("请输出本次排班中的人员信息")):3===e?(r("#title h3").text("已排班信息"),r("#title p").text("请输入已经排好的节假日信息")):4===e&&(r("#title h3").text("排班结果"),r("#title p").text("这里输出了排班的结果"),d()),1===t&&2===e&&(o.startDate=r("#startMonth").val(),o.endDate=r("#endMonth").val()),2===t?i.postUserTable():3===t&&c.postTable()})});