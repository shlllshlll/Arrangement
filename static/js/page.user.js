"use strict";define(["jquery","common","xlsx","module.datatable","module.utils"],function(t,e,o,n,l){var a=e.dataUrl,r=["name","type","remark","history","month","times"],i=null,u=null;function s(){t.ajax({type:"GET",url:a,dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){"String"==typeof t&&(t=JSON.parse(t)),i=t,f(t.peopledata)}).fail(function(){return e.showNotification("获取数据失败，请检查服务器连接！","danger")})}function c(t){var e=t.data.rowIndex,o=t.data.rowData;l.showModal("delRowModal","警告","是否确定删除"+o[0]+"的数据",function(){i.peopledata.splice(e,1),f(i.peopledata)},"okDelRowBtn")}var d=[{value:"本院住院医",display:"本院住院医"},{value:"八年制（骨科）",display:"八年制（骨科）"},{value:"八年制（非骨科）",display:"八年制（非骨科）"},{value:"研究生（骨科）",display:"研究生（骨科）"},{value:"研究生（非骨科）",display:"研究生（非骨科）"},{value:"骨科临博",display:"骨科临博"},{value:"基地住院医",display:"基地住院医"},{value:"进修医",display:"进修医"},{value:"其他",display:"其他"}];function f(e){var o=function(t){console.log("人员数据",t);for(var e=JSON.parse(JSON.stringify(t)),o=[],n=0;n<e.length;n++){var l=[],a="",r=!0,i=!1,u=void 0;try{for(var s,c=e[n].history[Symbol.iterator]();!(r=(s=c.next()).done);r=!0){var d=s.value;a+="(",a+=d.name,a+=":";var f=!0,p=!1,h=void 0;try{for(var y,v=d.month[Symbol.iterator]();!(f=(y=v.next()).done);f=!0)a+=y.value+" "}catch(t){p=!0,h=t}finally{try{f||null==v.return||v.return()}finally{if(p)throw h}}a+=")"}}catch(t){i=!0,u=t}finally{try{r||null==c.return||c.return()}finally{if(i)throw u}}var m="";e[n].remark&&(m=e[n].remark),l.push(e[n].name),l.push(e[n].type),l.push(m),l.push(a),l.push(e[n].month.toString()),l.push(e[n].times),o.push(l)}return console.log("表格数据",o),o}(e);(u=l.getInstance(u,n,["#datatables"])).createTable(o,{table:{autoWidth:!0,ordering:!1,data:o,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"人员信息表",title:null}],columns:[{title:"姓名"},{title:"类别"},{title:"备注"},{title:"排班历史"},{title:"排班月份"},{title:"总排班月份数"},{name:"control",searchable:!1,title:"操作",orderable:!1,defaultContent:'<input type="button" value="❌" style="border-style: none;background: inherit;">',createdCell:function(e,o,n,l,a){t(e).on("click","input",{rowIndex:l,rowData:n},c)}}]},cellEditable:!0,cellEdit:{columns:[1,2,4],onUpdate:p,inputTypes:[{column:1,type:"list",options:d}]}})}function p(t,e,o){var n=t.data();if(n!==o){var l=t.index().column,a=r[l],u=t.index().row;4===l&&(n=(n=n.split(",")).map(function(t){return"number"==typeof t?t.toString():t}),t.table().cell({row:u,column:5}).data(n.length).draw(),i.peopledata[u].times=n.length),i.peopledata[u][a]=n}}function h(){var e=t("#formName").val(),o=t("#formType").val(),n=t("#formRemark").val(),l=t("#formMonth").val(),a=(t("#formHistory").val(),[]),r=!0,u=!1,s=void 0;try{for(var c,d=i.peopledata[Symbol.iterator]();!(r=(c=d.next()).done);r=!0){var p=c.value;a.push(p.name)}}catch(t){u=!0,s=t}finally{try{r||null==d.return||d.return()}finally{if(u)throw s}}if(-1===a.indexOf(e)){var h={name:e,month:l=(l=l.split(",")).map(function(t){return"number"==typeof t?t.toString():t}),times:l.length,type:o,remark:n,history:[]};i.peopledata.unshift(h),f(i.peopledata)}else alert("该人已存在于数据库中")}s(),t("#xslxUpload").change(function(){var n=t("#xslxUpload")[0].files[0],l=new FileReader;l.onload=function(n){console.log("文件读取完成");var l=n.target.result;for(var a=o.read(l,{type:"binary"}),r=a.SheetNames[0],i=a.Sheets[r],u=o.utils.sheet_to_json(i),c=[],d=0;d<u.length;d++){var f={month:[]};for(var p in u[d]){var h=u[d]["姓名"];f.name=h,"骨"===u[d][p]&&f.month.push(String(p))}c.push(f)}console.log("读取的数据",c),t.ajax({type:"POST",url:e.uploadUrl,data:JSON.stringify(c),dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){s()}).fail(function(){return e.showNotification("数据保存失败，请检查服务器连接！","danger")})},l.readAsBinaryString(n)}),t("#saveBtn").click(function(){t.ajax({type:"POST",url:a,data:JSON.stringify(i),dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){"String"==typeof t&&(t=JSON.parse(t)),"ok"===t.status&&e.showNotification("数据保存成功！","success")}).fail(function(){return e.showNotification("数据保存失败，请检查服务器连接！","danger")})}),t("#delBtn").click(function(){l.showModal("delModal","警告","是否确定删除数据",function(){t.ajax({type:"GET",url:e.clearUrl,dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){e.showNotification("数据清楚成功","success"),s()}).fail(function(){return e.showNotification("请检查服务器连接！","danger")})},"okDelBtn")}),t("#outputBtn").click(function(){l.showModal("outputModal","请选择输出的数据","<select class=\"form-control col-sm-7\" id=\"inputModalType\">\n                    <option value='0'>全部数据</option>\n                    <option value='1'>按类别输出</option>\n                </select>",function(){switch(t("#inputModalType").val()){case"0":u.table.buttons(".buttons-excel").trigger();break;case"1":for(var e=[],n=t("th",u.table.header()),l=0;l<n.length-1;l++)e.push(t(n[l]).text());for(var a=[],r=0;r<d.length;r++){var i=d[r];a.push(i.value)}for(var s=Array(a.length+1),c=0;c<s.length;c++)s[c]=[e];u.table.data().toArray().forEach(function(t){var e=a.indexOf(t[1]);-1!==e?s[e].push(t):s[s.length-1].push(t)}),a.push("未分类");var f={};a.forEach(function(t,e){f[t]=o.utils.aoa_to_sheet(s[e])});var p={SheetNames:a,Sheets:f};o.writeFile(p,"人员信息表_按类型分.xlsx")}},"outputModalBtn")}),t("#addBtn").click(function(){t("#mymodal").modal()}),t("#formNxtBtn").click(function(){h()}),t("#formOkBtn").click(function(){h(),t("#mymodal").modal("hide")})});