"use strict";define(["jquery","common","xlsx","module.datatable","module.utils"],function(t,e,o,a,n){var l=e.dataUrl,r=["name","type","remark","history","month","times"],i=null,u=null;function s(){t.ajax({type:"GET",url:l,dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){"String"==typeof t&&(t=JSON.parse(t)),i=t,f(t.peopledata)}).fail(function(){return e.showNotification("获取数据失败，请检查服务器连接！","danger")})}function c(t){var e=t.data.rowIndex,o=t.data.rowData;n.showModal("delRowModal","警告","是否确定删除"+o[0]+"的数据",function(){i.peopledata.splice(e,1),f(i.peopledata)},"okDelRowBtn")}var d=[{value:"本院住院医",display:"本院住院医"},{value:"八年制（骨科）",display:"八年制（骨科）"},{value:"八年制（非骨科）",display:"八年制（非骨科）"},{value:"研究生（骨科）",display:"研究生（骨科）"},{value:"研究生（非骨科）",display:"研究生（非骨科）"},{value:"骨科临博",display:"骨科临博"},{value:"基地住院医",display:"基地住院医"},{value:"进修医",display:"进修医"},{value:"其他",display:"其他"}];function f(e){var o=function(t){console.log("人员数据",t);for(var e=JSON.parse(JSON.stringify(t)),o=[],a=0;a<e.length;a++){var n=[],l="",r=!0,i=!1,u=void 0;try{for(var s,c=e[a].history[Symbol.iterator]();!(r=(s=c.next()).done);r=!0){var d=s.value;l+="(",l+=d.name,l+=":";var f=!0,p=!1,h=void 0;try{for(var y,m=d.month[Symbol.iterator]();!(f=(y=m.next()).done);f=!0)l+=y.value+" "}catch(t){p=!0,h=t}finally{try{f||null==m.return||m.return()}finally{if(p)throw h}}l+=")"}}catch(t){i=!0,u=t}finally{try{r||null==c.return||c.return()}finally{if(i)throw u}}var v="";e[a].remark&&(v=e[a].remark),n.push(e[a].name),n.push(e[a].type),n.push(v),n.push(l),n.push(e[a].month.toString()),n.push(e[a].times),o.push(n)}return console.log("表格数据",o),o}(e);(u=n.getInstance(u,a,["#datatables"])).createTable(o,{table:{autoWidth:!0,ordering:!1,data:o,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"人员信息表",title:null}],columns:[{title:"姓名"},{title:"类别"},{title:"备注"},{title:"排班历史"},{title:"排班月份"},{title:"总排班月份数"},{name:"control",searchable:!1,title:"操作",orderable:!1,defaultContent:'<input type="button" value="❌" style="border-style: none;background: inherit;">',createdCell:function(e,o,a,n,l){t(e).on("click","input",{rowIndex:n,rowData:a},c)}}]},cellEditable:!0,cellEdit:{columns:[1,2,4],onUpdate:p,inputTypes:[{column:1,type:"list",options:d}]}})}function p(t,e,o){var a=t.data();if(a!==o){var n=t.index().column,l=r[n],u=t.index().row;4===n&&(a=(a=a.split(",")).map(function(t){return"number"==typeof t?t.toString():t}),t.table().cell({row:u,column:5}).data(a.length).draw(),i.peopledata[u].times=a.length),i.peopledata[u][l]=a}}function h(){var e=t("#formName").val(),o=t("#formType").val(),a=t("#formRemark").val(),n=t("#formMonth").val(),l=(t("#formHistory").val(),[]),r=!0,u=!1,s=void 0;try{for(var c,d=i.peopledata[Symbol.iterator]();!(r=(c=d.next()).done);r=!0){var p=c.value;l.push(p.name)}}catch(t){u=!0,s=t}finally{try{r||null==d.return||d.return()}finally{if(u)throw s}}if(-1===l.indexOf(e)){var h={name:e,month:n=(n=n.split(",")).map(function(t){return"number"==typeof t?t.toString():t}),times:n.length,type:o,remark:a,history:[]};i.peopledata.unshift(h),f(i.peopledata)}else alert("该人已存在于数据库中")}s(),t("#xslxUpload").change(function(){var a=t("#xslxUpload")[0].files[0],n=new FileReader;n.onload=function(a){console.log("文件读取完成");var n=a.target.result;var l=o.read(n,{type:"binary"}),r=[],i=!0,u=!1,c=void 0;try{for(var d,f=l.SheetNames[Symbol.iterator]();!(i=(d=f.next()).done);i=!0)for(var p=d.value,h=l.Sheets[p],y=o.utils.sheet_to_json(h),m=0;m<y.length;m++){var v={};v.name=y[m]["姓名"],v.type=y[m]["类别"],v.remark=y[m]["备注"],y[m]["排班历史"]?v.history=y[m]["排班历史"]:v.history="",v.month=y[m]["排班月份"],r.push(v)}}catch(t){u=!0,c=t}finally{try{i||null==f.return||f.return()}finally{if(u)throw c}}console.log("读取的数据",r),t.ajax({type:"POST",url:e.uploadUrl,data:JSON.stringify(r),dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){s()}).fail(function(){return e.showNotification("数据保存失败，请检查服务器连接！","danger")})},n.readAsBinaryString(a)}),t("#saveBtn").click(function(){t.ajax({type:"POST",url:l,data:JSON.stringify(i),dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){"String"==typeof t&&(t=JSON.parse(t)),"ok"===t.status&&e.showNotification("数据保存成功！","success")}).fail(function(){return e.showNotification("数据保存失败，请检查服务器连接！","danger")})}),t("#delBtn").click(function(){n.showModal("delModal","警告","是否确定删除数据",function(){t.ajax({type:"GET",url:e.clearUrl,dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(t){e.showNotification("数据清楚成功","success"),s()}).fail(function(){return e.showNotification("请检查服务器连接！","danger")})},"okDelBtn")}),t("#outputBtn").click(function(){n.showModal("outputModal","请选择输出的数据","<select class=\"form-control col-sm-7\" id=\"inputModalType\">\n                    <option value='0'>全部数据</option>\n                    <option value='1'>按类别输出</option>\n                </select>",function(){switch(t("#inputModalType").val()){case"0":u.table.buttons(".buttons-excel").trigger();break;case"1":for(var e=[],a=t("th",u.table.header()),n=0;n<a.length-1;n++)e.push(t(a[n]).text());for(var l=[],r=0,i=d;r<i.length;r++){var s=i[r];l.push(s.value)}for(var c=Array(l.length+1),f=0;f<c.length;f++)c[f]=[e];u.table.data().toArray().forEach(function(t){var e=l.indexOf(t[1]);-1!==e?c[e].push(t):c[c.length-1].push(t)}),l.push("未分类");var p={};l.forEach(function(t,e){p[t]=o.utils.aoa_to_sheet(c[e])});var h={SheetNames:l,Sheets:p};o.writeFile(h,"人员信息表_按类型分.xlsx")}},"outputModalBtn")}),t("#addBtn").click(function(){t("#mymodal").modal()}),t("#formNxtBtn").click(function(){h()}),t("#formOkBtn").click(function(){h(),t("#mymodal").modal("hide")})});