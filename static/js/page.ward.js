"use strict";define(["jquery","xlsx","common","module.datatable","module.utils","crc","bootstrap.navtab","module.datachecker","datepicker","datepicker.zh-CN"],function(t,e,a,n,o,r,l,i){var c=null,s=null,u=null,d=null,f=null,h=null,p=[],m=[],v=[],g=[],b=[];function y(e,r){if(2===e&&(S(),B()),1===r)t("#title h3").text("选择科室排班文件"),t("#title p").text("选择输入的科室排班文件数据，用于后续的病房排班");else if(2===r){if(O(),1===e){h||(h=t("#fileMonth").val().split("/").join(""));var l={title:m,data:p,month:h};o.postJson({url:a.departUrl,data:JSON.stringify(l)},function(){return a.showNotification("历史数据保存成功！","success")},function(){return a.showNotification("历史数据保存失败！","danger")})}t("#title h3").text("编辑科室排班数据"),t("#title p").text("通过编辑下面的表格中的人员名单来更新人员名单数据"),function(e){var a=[{title:"骨1"},{title:"骨2"},{title:"骨3"},{title:"骨4"},{title:"小辅班"},{title:"急诊一线"}],r=!!s;(s=o.getInstance(s,n,["#datatables2"])).createTable([],{table:{paging:!1,ordering:!1,autoWidth:!0,columns:a}}),r||I();(f=f||new n("#datatables5")).createTable(g,{table:{searching:!1,ordering:!1,autoWidth:!0,columns:v}}),t("#datatables2 tbody").on("click","td",function(){var t=s.table.cell(this),e=(t.index(),t.data());""!==e&&o.showModal("modal2","注意","是否确认取消"+e+"的病房安排",function(){e=e.match(/(\S*)\((.+?)\)/)[1];var a=!1;p.every(function(t,n){return-1===t.indexOf(e)||(x(f,n,e,v.length),a=!0,!1)}),a&&k(s,t)},"okBtn2")}),t("#datatables5 tbody").on("click","td",function(){var e=f.table.cell(this),n=e.index(),r=e.data(),l=e.table().column(n.column).title();""!==r&&o.showModal("modal","请选择"+r+"的病房",'<div class="form-group row">\n                            <label for="formType" class="col-sm-3 col-form-label">身份</label>\n                            <select class="form-control col-sm-7" id="table5Type">\n                                <option value="0">骨1</option>\n                                <option value="1">骨2</option>\n                                <option value="2">骨3</option>\n                                <option value="3">骨4</option>\n                                <option value="4">小辅班</option>\n                                <option value="5">急诊一线</option>\n                            </select>\n                        </div>',function(){k(f,e),r+="("+l+")";var o=t("#table5Type").val().toString();s.table.rows().data().length,n.column;x(s,o,r,a.length)},"okBtn")})}()}else if(3===r){t("#title h3").text("日期及休假设置"),t("#title p").text("在下面的表单中填写日期和人员的请假信息"),t('[data-toggle="daypicker"]').datepicker({format:"dd",language:"zh-CN",autoHide:!0,date:t("#fileMonth").datepicker("getDate")});(u=u||new n("#datatables3")).createTable([],{table:{searching:!1,ordering:!1,autoWidth:!0,paging:!1,info:!1,columns:[{title:"姓名"},{title:"起始日期"},{title:"结束日期"}]}})}else if(4===r){if(3===e){for(var i=t("#startday").val(),c=t("#endday").val(),y=t("#datatables3").dataTable().api().data(),w=[],N=0;N<y.length;N++){var A=y[N],J={};-1===A.indexOf("")&&(J.name=A[0],J.start=A[1],J.end=A[2],w.push(J))}for(var T={month:h,startday:i,endday:c,data:w},_=[],D=s.table.columns().data(),E=0;E<D.length;E++){var W=D[E];W.remove(""),W.length>0&&_.push(W)}var j={range:T,people:_};t.ajax({type:"POST",url:a.wardUrl,data:JSON.stringify(j),dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(e){"String"==typeof e&&(e=JSON.parse(e)),function(e){var a=[{title:"日期"},{title:"星期"},{title:"骨1"},{title:"骨2"},{title:"骨3"},{title:"骨4"},{title:"小辅班"},{title:"急诊一线"}];b=[];for(var n=0;n<e[0].length;n++){for(var o=[],r=0;r<e.length;r++)o.push(e[r][n]);var l=a.length-e.length;o=o.concat(Array(l).fill("")),b.push(o)}d?(d.clear(),d.rows.add(b).draw()):d=t("#datatables4").DataTable({searching:!1,ordering:!1,autoWidth:!0,pagint:!1,data:b,columns:a,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"病房排班表",title:null}]})}(e)}).fail(function(){return a.showNotification("数据保存失败，请检查服务器连接！","danger")})}t("#title h3").text("排班结果输出"),t("#title p").text("下面的表格输出了最终的病房排班结果，可以使用到处按钮到处文件")}}function w(){!function(a){for(var n=["骨1","骨2","骨3","骨4","小辅班","急诊一线"],o=[],r=[],l=[],i=[],c=[],s=0;s<n.length;s++)o.push(new Array),r.push(new Array),l.push(new Array),i.push(0),c.push(0);var u=function(t){return t<6},f=function(t){return 0===t.length?0:t.reduce(function(t,e){return t+e})},h=function(t){return 0===t.length?0:f(t)/t.length},p=function(t){var e=0,a=0,n=!0,o=!1,r=void 0;try{for(var l,i=t[Symbol.iterator]();!(n=(l=i.next()).done);n=!0){var c=l.value;e+=f(c),a+=c.length}}catch(t){o=!0,r=t}finally{try{n||null==i.return||i.return()}finally{if(o)throw r}}return 0===e?0:e/a},m=!0,v=!1,g=void 0;try{for(var b,y=a[Symbol.iterator]();!(m=(b=y.next()).done);m=!0)for(var w=b.value,x=2;x<w.length;x++)if(""!==w[x]){var k=o[x-2].indexOf(w[x]);-1===k?(o[x-2].push(w[x]),u(w[1])?(r[x-2].push(1),l[x-2].push(0)):(r[x-2].push(0),l[x-2].push(1))):u(w[1])?r[x-2][k]++:l[x-2][k]++}}catch(t){v=!0,g=t}finally{try{m||null==y.return||y.return()}finally{if(v)throw g}}for(var N=0;N<r.length;N++)i[N]=h(r[N]),c[N]=h(l[N]);p(r),p(l);var S=n.concat("分病房统计"),A={};n.forEach(function(t,a){for(var n=[["姓名","周中班数","周末班数"]],i=0;i<o[a].length;i++)n.push([o[a][i],r[a][i],l[a][i]]);A[t]=e.utils.aoa_to_sheet(n)});var O=[["病房","平均周中班数","平均周末班数"]];n.forEach(function(t,e){O.push([t,i[e],c[e]])}),A[S[S.length-1]]=e.utils.aoa_to_sheet(O),S.splice(0,0,"名单");var B=[[]];t("#datatables4 thead th").each(function(){B[0].push(t(this).html())}),B=B.concat(d.data().toArray()),A[S[0]]=e.utils.aoa_to_sheet(B);var I={SheetNames:S,Sheets:A};e.writeFile(I,"病房排班统计信息表.xlsx")}(b)}function x(t,e,a,n){var o=t.table.column(e).data().toArray();if(o.length&&""===o[o.length-1])o.every(function(n,o){return""!==n||(t.table.cell({row:o,column:e}).data(a),!1)});else{var r=Array(n).fill("");r[e]=a,t.table.row.add(r).draw()}t.table.draw()}function k(t,e){var a=t.table.data().toArray();!function(t,e){if(e.row===t.length-1)t[e.row][e.column]="";else for(var a=e.row+1;a<t.length&&(t[a-1][e.column]=t[a][e.column],""!==t[a][e.column]);a++)t[a][e.column]="";for(var n=t[t.length-1],o=!0,r=0;r<n.length;r++)if(""!==n[r]){o=!1;break}o&&t.pop()}(a,e.index()),t.updateData(a)}t("#xslxUpload").change(function(){var a=t("#xslxUpload")[0].files[0],o=new FileReader;o.onload=function(t){var a=t.target.result;var o=e.read(a,{type:"binary"}),r=o.SheetNames[0],l=o.Sheets[r],i=e.utils.sheet_to_json(l,{header:1}),s=i.length,u=i[0].length;for(var d in m=[],i[0])m[parseInt(d)]=i[0][d];g=[];for(var f=1;f<s;f++){for(var h=[],b=0;b<u;b++)h[b]="";for(var y in i[f])h[parseInt(y)]=i[f][y];g.push(h)}p=[];for(var w=0;w<g[0].length;w++){for(var x=[],k=0;k<g.length;k++){var N=g[k][w];N&&x.push(N)}p.push(x)}v=[],m.forEach(function(t){return v.push({title:t})}),(c=c||new n("#datatables")).createTable(g,{table:{searching:!1,ordering:!1,autoWidth:!0,columns:v}})},o.readAsBinaryString(a)});var N=null,S=function(){var t={type:"depart_bak",month:h};t.crc=r.crc32(JSON.stringify(g)),t.table2=s.table.data().toArray(),t.table5=f.table.data().toArray(),o.postJson({url:a.backupWard,data:JSON.stringify(t)},function(){return a.showNotification("备份成功！","success")},function(){return a.showNotification("备份失败，请检查服务器连接！","danger")})},A=function(){S()},O=function(){N||(N=setInterval(A,6e4),a.showNotification("数据备份已开启，每60s备份一次","info"))},B=function(){clearInterval(N),N=null,a.showNotification("数据备份已关闭","info")},I=function(t){o.getJson({url:a.backupWard},function(t){"String"==typeof t&&(t=JSON.parse(t)),t.type&&"depart_bak"===t.type&&parseInt(t.month)===parseInt(h)&&t.crc===r.crc32(JSON.stringify(g))?(s.updateData(t.table2),f.updateData(t.table5),a.showNotification("数据恢复成功！","success")):a.showNotification("备份数据与当前选项不符","warning"),O()},function(){return a.showNotification("恢复失败，请检查服务器连接！","danger")})};t("#saveBtn").click(S),t("#addRestData").click(function(){o.showModal("modal3","请添加一条请假信息",'<form>\n                          <div class="form-group row">\n                            <label for="formName" class="col-sm-3 col-form-label">姓名</label>\n                            <input type="text" class="form-control col-sm-7" id="formName">\n                          </div>\n                          <div class="form-group row">\n                            <label for="formStart" class="col-sm-3 col-form-label">起始日期</label>\n                            <input type="text" class="form-control col-sm-7" id="formStart" placeholder="1">\n                          </div>\n                          <div class="form-group row">\n                            <label for="formEnd" class="col-sm-3 col-form-label">结束日期</label>\n                            <input type="text" class="form-control col-sm-7" id="formEnd" placeholder="5">\n                          </div>\n                        </form>',function(){var e=[];e.push(t("#formName").val()),e.push(t("#formStart").val()),e.push(t("#formEnd").val()),u.table.row.add(e).draw()},"okBtn3")}),function(){var e=sessionStorage.getItem("month"),a=sessionStorage.getItem("table");sessionStorage.clear();var n={1:[{dom:"#fileMonth",checker:function(t){return t?null:"日期不能为空"}},{dom:"#xslxUploadBtn",checker:function(){return g.length?null:"请选择文件"}}],2:[],3:[{dom:"#startday",checker:function(t){return t?null:"日期不能为空"}},{dom:"#endday",checker:function(e){if(!e)return"日期不能为空";var a=parseInt(t("#startday").val());return parseInt(e)<a?"请确保结束日期晚于开始日期":null}}],4:[]};if(new l("#mytab","#nextBtn","#backBtn","#finishBtn",y,w,function(t){return(new i).formDataChecker(n[t])}),t('[data-toggle="datepicker"]').datepicker({format:"yy/mm",language:"zh-CN",autoHide:!0}),null!==e&&null!==a){a=JSON.parse(a),h=e,v=a.col,m=[],v.forEach(function(t){return m.push(t.title)}),g=a.data,p=[];for(var o=0;o<g[0].length;o++){for(var r=[],c=0;c<g.length;c++){var s=g[c][o];s&&r.push(s)}p.push(r)}t("#nextBtn").click()}}()});