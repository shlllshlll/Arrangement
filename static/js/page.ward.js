"use strict";define(["jquery","xlsx","common","module.datatable","module.utils","crc"],function(t,n,r,o,a,i){var e=null,s=null,f=null,u=null,c=null,h=null,l=[],d=[],p=[],v=[],g=[];function m(t,n,r,o){var a=t.table.column(n).data().toArray();if(a.length&&""===a[a.length-1])a.every(function(o,a){return""!==o||(t.table.cell({row:a,column:n}).data(r),!1)});else{var i=Array(o).fill("");i[n]=r,t.table.row.add(i).draw()}t.table.draw()}function y(t,n){var r=t.table.data().toArray();!function(t,n){if(n.row===t.length-1)t[n.row][n.column]="";else for(var r=n.row+1;r<t.length&&(t[r-1][n.column]=t[r][n.column],""!==t[r][n.column]);r++)t[r][n.column]="";for(var o=t[t.length-1],a=!0,i=0;i<o.length;i++)if(""!==o[i]){a=!1;break}a&&t.pop()}(r,n.index()),t.updateData(r)}t("#xslxUpload").change(function(){var r=t("#xslxUpload")[0].files[0],a=new FileReader;a.onload=function(t){var r=t.target.result;var a=n.read(r,{type:"binary"}),i=a.SheetNames[0],s=a.Sheets[i],f=n.utils.sheet_to_json(s,{header:1}),u=f.length,c=f[0].length;for(var h in d=[],f[0])d[parseInt(h)]=f[0][h];v=[];for(var g=1;g<u;g++){for(var m=[],y=0;y<c;y++)m[y]="";for(var w in f[g])m[parseInt(w)]=f[g][w];v.push(m)}l=[];for(var b=0;b<v[0].length;b++){for(var S=[],k=0;k<v.length;k++){var N=v[k][b];N&&S.push(N)}l.push(S)}p=[],d.forEach(function(t){return p.push({title:t})}),(e=e||new o("#datatables")).createTable(v,{table:{searching:!1,ordering:!1,autoWidth:!0,columns:p}})},a.readAsBinaryString(r)}),t('a[data-toggle="tab"]').on("shown.bs.tab",function(n){var i=t(n.target).attr("aria-controls");i=parseInt(i.replace(/[^0-9]/gi,""));var e=t(n.relatedTarget).attr("aria-controls");if(2===(e=parseInt(e.replace(/[^0-9]/gi,"")))&&(b(),N()),1===i)t("#title h3").text("选择科室排班文件"),t("#title p").text("选择输入的科室排班文件数据，用于后续的病房排班");else if(2===i){if(k(),1===e){h||(h=t("#fileMonth").val());var w={title:d,data:l,month:h};a.postJson({url:r.departUrl,data:JSON.stringify(w)},function(){return r.showNotification("历史数据保存成功！","success")},function(){return r.showNotification("历史数据保存失败！","danger")})}t("#title h3").text("编辑科室排班数据"),t("#title p").text("通过编辑下面的表格中的人员名单来更新人员名单数据"),function(n){var r=[{title:"骨1"},{title:"骨2"},{title:"骨3"},{title:"骨4"},{title:"小辅班"},{title:"急诊一线"}],i=!!s;(s=a.getInstance(s,o,["#datatables2"])).createTable([],{table:{paging:!1,ordering:!1,autoWidth:!0,columns:r}}),i||O();(c=c||new o("#datatables5")).createTable(v,{table:{searching:!1,ordering:!1,autoWidth:!0,columns:p}}),t("#datatables2 tbody").on("click","td",function(){var t=s.table.cell(this),n=(t.index(),t.data());""!==n&&a.showModal("modal2","注意","是否确认取消"+n+"的病房安排",function(){n=n.match(/(\S*)\((.+?)\)/)[1];var r=!1;l.every(function(t,o){return-1===t.indexOf(n)||(m(c,o,n,p.length),r=!0,!1)}),r&&y(s,t)},"okBtn2")}),t("#datatables5 tbody").on("click","td",function(){var n=c.table.cell(this),o=n.index(),i=n.data(),e=n.table().column(o.column).title();""!==i&&a.showModal("modal","请选择"+i+"的病房",'<div class="form-group row">\n                            <label for="formType" class="col-sm-3 col-form-label">身份</label>\n                            <select class="form-control col-sm-7" id="table5Type">\n                                <option value="0">骨1</option>\n                                <option value="1">骨2</option>\n                                <option value="2">骨3</option>\n                                <option value="3">骨4</option>\n                                <option value="4">小辅班</option>\n                                <option value="5">急诊一线</option>\n                            </select>\n                        </div>',function(){y(c,n),i+="("+e+")";var a=t("#table5Type").val().toString();s.table.rows().data().length,o.column;m(s,a,i,r.length)},"okBtn")})}()}else if(3===i){t("#title h3").text("日期及休假设置"),t("#title p").text("在下面的表单中填写日期和人员的请假信息");(f=f||new o("#datatables3")).createTable([],{table:{searching:!1,ordering:!1,autoWidth:!0,paging:!1,info:!1,columns:[{title:"姓名"},{title:"起始日期"},{title:"结束日期"}]}})}else if(4===i){if(3===e){for(var S=t("#startday").val(),B=t("#endday").val(),J=t("#datatables3").dataTable().api().data(),_=[],E=0;E<J.length;E++){var W=J[E],j={};-1===W.indexOf("")&&(j.name=W[0],j.start=W[1],j.end=W[2],_.push(j))}for(var I={month:h,startday:S,endday:B,data:_},x=[],R=s.table.columns().data(),q=0;q<R.length;q++){var A=R[q];A.remove(""),A.length>0&&x.push(A)}var H={range:I,people:x};t.ajax({type:"POST",url:r.wardUrl,data:JSON.stringify(H),dataType:"json",xhrFields:{"Access-Control-Allow-Origin":"*"}}).done(function(n){"String"==typeof n&&(n=JSON.parse(n)),function(n){var r=[{title:"日期"},{title:"星期"},{title:"骨1"},{title:"骨2"},{title:"骨3"},{title:"骨4"},{title:"小辅班"},{title:"急诊一线"}];g=[];for(var o=0;o<n[0].length;o++){for(var a=[],i=0;i<n.length;i++)a.push(n[i][o]);var e=r.length-n.length;a=a.concat(Array(e).fill("")),g.push(a)}u?(u.clear(),u.rows.add(g).draw()):u=t("#datatables4").DataTable({searching:!1,ordering:!1,autoWidth:!0,pagint:!1,data:g,columns:r,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"病房排班表",title:null}]})}(n)}).fail(function(){return r.showNotification("数据保存失败，请检查服务器连接！","danger")})}t("#title h3").text("排班结果输出"),t("#title p").text("下面的表格输出了最终的病房排班结果，可以使用到处按钮到处文件")}}),t("#finishBtn").click(function(){!function(r){for(var o=["骨1","骨2","骨3","骨4","小辅班","急诊一线"],a=[],i=[],e=[],s=[],f=[],c=0;c<o.length;c++)a.push(new Array),i.push(new Array),e.push(new Array),s.push(0),f.push(0);var h=function(t){return t<6},l=function(t){return 0===t.length?0:t.reduce(function(t,n){return t+n})},d=function(t){return 0===t.length?0:l(t)/t.length},p=function(t){var n=0,r=0,o=!0,a=!1,i=void 0;try{for(var e,s=t[Symbol.iterator]();!(o=(e=s.next()).done);o=!0){var f=e.value;n+=l(f),r+=f.length}}catch(t){a=!0,i=t}finally{try{o||null==s.return||s.return()}finally{if(a)throw i}}return 0===n?0:n/r},v=!0,g=!1,m=void 0;try{for(var y,w=r[Symbol.iterator]();!(v=(y=w.next()).done);v=!0)for(var b=y.value,S=2;S<b.length;S++)if(""!==b[S]){var k=a[S-2].indexOf(b[S]);-1===k?(a[S-2].push(b[S]),h(b[1])?(i[S-2].push(1),e[S-2].push(0)):(i[S-2].push(0),e[S-2].push(1))):h(b[1])?i[S-2][k]++:e[S-2][k]++}}catch(t){g=!0,m=t}finally{try{v||null==w.return||w.return()}finally{if(g)throw m}}for(var N=0;N<i.length;N++)s[N]=d(i[N]),f[N]=d(e[N]);p(i),p(e);var O=o.concat("分病房统计"),B={};o.forEach(function(t,r){for(var o=[["姓名","周中班数","周末班数"]],s=0;s<a[r].length;s++)o.push([a[r][s],i[r][s],e[r][s]]);B[t]=n.utils.aoa_to_sheet(o)});var J=[["病房","平均周中班数","平均周末班数"]];o.forEach(function(t,n){J.push([t,s[n],f[n]])}),B[O[O.length-1]]=n.utils.aoa_to_sheet(J),O.splice(0,0,"名单");var _=[[]];t("#datatables4 thead th").each(function(){_[0].push(t(this).html())}),_=_.concat(u.data().toArray()),B[O[0]]=n.utils.aoa_to_sheet(_);var E={SheetNames:O,Sheets:B};n.writeFile(E,"病房排班统计信息表.xlsx")}(g)});var w=null,b=function(){var t={type:"depart_bak",month:h};t.crc=i.crc32(JSON.stringify(v)),t.table2=s.table.data().toArray(),t.table5=c.table.data().toArray(),a.postJson({url:r.backupWard,data:JSON.stringify(t)},function(){return r.showNotification("备份成功！","success")},function(){return r.showNotification("备份失败，请检查服务器连接！","danger")})},S=function(){b()},k=function(){w||(w=setInterval(S,6e4),r.showNotification("数据备份已开启，每60s备份一次","info"))},N=function(){clearInterval(w),w=null,r.showNotification("数据备份已关闭","info")},O=function(t){a.getJson({url:r.backupWard},function(t){"String"==typeof t&&(t=JSON.parse(t)),t.type&&"depart_bak"===t.type&&parseInt(t.month)===parseInt(h)&&t.crc===i.crc32(JSON.stringify(v))?(s.updateData(t.table2),c.updateData(t.table5),r.showNotification("数据恢复成功！","success")):r.showNotification("备份数据与当前选项不符","warning"),k()},function(){return r.showNotification("恢复失败，请检查服务器连接！","danger")})};t("#saveBtn").click(b),t("#addRestData").click(function(){a.showModal("modal3","请添加一条请假信息",'<form>\n                          <div class="form-group row">\n                            <label for="formName" class="col-sm-3 col-form-label">姓名</label>\n                            <input type="text" class="form-control col-sm-7" id="formName">\n                          </div>\n                          <div class="form-group row">\n                            <label for="formStart" class="col-sm-3 col-form-label">起始日期</label>\n                            <input type="text" class="form-control col-sm-7" id="formStart" placeholder="1">\n                          </div>\n                          <div class="form-group row">\n                            <label for="formEnd" class="col-sm-3 col-form-label">结束日期</label>\n                            <input type="text" class="form-control col-sm-7" id="formEnd" placeholder="5">\n                          </div>\n                        </form>',function(){var n=[];n.push(t("#formName").val()),n.push(t("#formStart").val()),n.push(t("#formEnd").val()),f.table.row.add(n).draw()},"okBtn3")});var B=parseInt(t("#mytab li:last-child a").attr("aria-controls").replace(/[^0-9]/gi,""));t("#nextBtn").click(function(){var n=t(".nav-link.active").attr("aria-controls");n=parseInt(n.replace(/[^0-9]/gi,"")),t("#mytab li:nth-child("+(n>=B?n:n+1)+") a").tab("show")}),t("#backBtn").click(function(){var n=t(".nav-link.active").attr("aria-controls");n=parseInt(n.replace(/[^0-9]/gi,"")),t("#mytab li:nth-child("+(n>1?n-1:n)+") a").tab("show")}),t('a[data-toggle="tab"]').on("shown.bs.tab",function(n){var r=t(n.target).attr("aria-controls");1===(r=parseInt(r.replace(/[^0-9]/gi,"")))?t("#backBtn").addClass("disabled"):t("#backBtn").removeClass("disabled"),r===B?(t("#nextBtn").css("display","none"),t("#finishBtn").css("display","")):(t("#nextBtn").css("display",""),t("#finishBtn").css("display","none"))}),function(){var n=sessionStorage.getItem("month"),r=sessionStorage.getItem("table");if(sessionStorage.clear(),null!==n&&null!==r){r=JSON.parse(r),h=n,p=r.col,d=[],p.forEach(function(t){return d.push(t.title)}),v=r.data,l=[];for(var o=0;o<v[0].length;o++){for(var a=[],i=0;i<v.length;i++){var e=v[i][o];e&&a.push(e)}l.push(a)}t("#nextBtn").click()}}()});