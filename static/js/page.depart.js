"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var a=0,e=new Array(t.length);a<t.length;a++)e[a]=t[a];return e}}define(["jquery","common","module.utils","module.datatable","FileSaver"],function(t,a,e,r,n){var o=!1,l=null,i=null,c=null,u="1810",s=[],d=null;function f(t,a){for(var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.table.columns().data(),r=a[0];r<=a[1];r++){var n=e[r],o=!0,l=!0,i=!1,c=void 0;try{for(var u,s=n[Symbol.iterator]();!(l=(u=s.next()).done);l=!0){if(""!==u.value){o=!1;break}}}catch(t){i=!0,c=t}finally{try{l||null==s.return||s.return()}finally{if(i)throw c}}o&&t.table.column(r).visible(!1)}}function b(t,a){if(a.row===t.length-1)t[a.row][a.column]="";else for(var e=a.row+1;e<t.length&&(t[e-1][a.column]=t[e][a.column],""!==t[e][a.column]);e++)t[e][a.column]="";for(var r=t[t.length-1],n=!0,o=0;o<r.length;o++)if(""!==r[o]){n=!1;break}return n&&t.pop(),t}function p(t,a){var e=[],r=!0,n=!1,o=void 0;try{for(var l,i=a[Symbol.iterator]();!(r=(l=i.next()).done);r=!0){var c=l.value;e.push(c[0])}}catch(t){n=!0,o=t}finally{try{r||null==i.return||i.return()}finally{if(n)throw o}}var u=[],s=!0,d=!1,f=void 0;try{for(var p,v=t.table2[Symbol.iterator]();!(s=(p=v.next()).done);s=!0){var y=p.value;u.push(y[0])}}catch(t){d=!0,f=t}finally{try{s||null==v.return||v.return()}finally{if(d)throw f}}var h=!0,m=!1,g=void 0;try{for(var w,x=t.table3[Symbol.iterator]();!(h=(w=x.next()).done);h=!0){var S=w.value;u.push(S[0])}}catch(t){m=!0,g=t}finally{try{h||null==x.return||x.return()}finally{if(m)throw g}}for(var A=0;A<t.table.length;A++)for(var k=0;k<t.table[A].length;k++){var B=t.table[A][k];""!==B&&(-1===e.indexOf(B)&&b(t.table,{row:A,column:k}))}for(var O=0;O<t.table2.length;O++){var I=t.table2[O][0];-1===e.indexOf(I)&&t.table2.splice(O,1)}for(var N=0;N<t.table3.length;N++){var _=t.table3[N][0];-1===e.indexOf(_)&&t.table3.splice(N,1)}for(var j=0;j<t.table2.length;j++){var D=t.table2[j][0],J=e.indexOf(D);-1!==J&&t.table2.splice(j,1,a[J])}for(var T=0;T<t.table3.length;T++){var C=t.table3[T][0],H=e.indexOf(C);-1!==H&&(t.table3[T][1]=a[H][1])}for(var M=0;M<e.length;M++)-1===u.indexOf(e[M])&&t.table2.splice(0,0,a[M]);return t}t('a[data-toggle="tab"]').on("shown.bs.tab",function(n){var p=t(n.target).attr("aria-controls");p=parseInt(p.replace(/[^0-9]/gi,""));var v,y=t(n.relatedTarget).attr("aria-controls");y=parseInt(y.replace(/[^0-9]/gi,"")),1===p?(t("#title h3").text("输入月份"),t("#title p").text("请设置分组的月份")):2===p&&(1===y&&(u=t("#month").val(),(u=String(u))||(u="1810"),!1===o&&(o=!0,v=u,e.getJson({url:a.dataUrl},function(a){"String"==typeof a&&(a=JSON.parse(a)),console.log(a);var n=[],o=!0,u=!1,p=void 0;try{for(var y,h=a.peopledata[Symbol.iterator]();!(o=(y=h.next()).done);o=!0){var m=y.value;-1!==m.month.indexOf(v)&&n.push(m)}}catch(t){u=!0,p=t}finally{try{o||null==h.return||h.return()}finally{if(u)throw p}}var w=[];for(var x in a.departid)w.push(a.departid[x]);var S=w.map(function(t){return{title:t}});d=_toConsumableArray(S),(l=e.getInstance(l,r,["#datatables"])).createTable([],{table:{paging:!1,ordering:!1,columns:d,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"科室分组表",title:null}]}});var A=function(t){var a=(t=parseInt(t))%100,e=Math.floor(t/100);return a<=1?(a=12,e--):a--,(100*e+a).toString()},k=function(t){for(var a=[],e=0;e<8;e++)t=A(t),a.splice(0,0,t);return a}(v),B=k.map(function(t){return{title:t}}),O=[{title:"姓名"},{title:"类别"},{title:"备注"}].concat(_toConsumableArray(B));s=[];for(var I=0;I<n.length;I++){var N=n[I],_=Array(O.length).fill("");_[0]=N.name,_[1]=N.type,N.remark&&(_[2]=N.remark);var j=!0,D=!1,J=void 0;try{for(var T,C=N.history[Symbol.iterator]();!(j=(T=C.next()).done);j=!0){var H=T.value,M=!0,U=!1,W=void 0;try{for(var F,G=H.month[Symbol.iterator]();!(M=(F=G.next()).done);M=!0){var q=F.value,E=k.indexOf(q);-1!==E&&(_[E+3]=H.name)}}catch(t){U=!0,W=t}finally{try{M||null==G.return||G.return()}finally{if(U)throw W}}}}catch(t){D=!0,J=t}finally{try{j||null==C.return||C.return()}finally{if(D)throw J}}s.push(_)}(i=e.getInstance(i,r,["#datatables2"])).createTable(s,{table:{ordering:!1,autoWidth:!0,columns:O,dom:"<'row'<'col-md-4 d-flex justify-content-start align-items-center'l<'#mySelect'>><'col-md-8 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"带分组人员名单",title:null}]}}),f(i,[3,10]),t("#datatables tbody").on("click","td",function(){if(0!==l.table.data().toArray().length){var t=l.table.cell(this),a=(t.index(),t.data());""!==a&&e.showModal("modal","注意",a+"将被移出科室分组名单，重新退回待分组列表中，是否确定",function(){!function(t,a){var e=t.table.data().toArray(),r=a.index();b(e,r),t.updateData(e)}(l,t);for(var e=c.table.data().toArray(),r=0;r<e.length;r++)if(e[r][0]===a){var n=e.splice(r,1)[0];c.updateData(e);var o=i.table.data().toArray();n.pop(),o.splice(0,0,n),i.updateData(o);break}},"okBtn")}}),t("#datatables2 tbody").on("click","tr",function(){var a=i.table.row(this),r=a.data()[0],n=function(t){var a="",e=!0,r=!1,n=void 0;try{for(var o,l=t[Symbol.iterator]();!(e=(o=l.next()).done);e=!0){var i=o.value;a+='<button type="button" class="btn btn-outline-primary">',a+=i.title,a+="</button>"}}catch(t){r=!0,n=t}finally{try{e||null==l.return||l.return()}finally{if(r)throw n}}return a}(S);e.showModalNoBtn("modal","请选择"+r+"的科室",'<div class="row" id="departBtnGroup">\n                                '.concat(n,"\n                            </div>")),t("#departBtnGroup button").click(function(){if(0!==i.table.data().toArray().length){var e=a.data();a.remove(),i.table.draw(),e.push(t(this).text()),c.table.row.add(e).draw(),l.table.rows().data().length;var n=w.indexOf(t(this).text()),o=(l.table.column(0).data().toArray(),l.table.column(n).data().toArray());if(o.length&&""===o[o.length-1])o.every(function(t,a){return""!==t||(l.table.cell({row:a,column:n}).data(r),!1)});else{var u=Array(d.length).fill("");u[n]=r,l.table.row.add(u).draw()}l.table.draw(),t("#modal").modal("hide")}})});var R=[].concat(_toConsumableArray(O),[{title:v}]);(c=e.getInstance(c,r,["#datatables3"])).createTable([],{table:{ordering:!1,autoWidth:!0,columns:R,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"已分组人员名单",title:null}]}}),f(c,[3,10],i.table.columns().data()),g()},function(){return a.showNotification("获取数据失败，请检查服务器连接！","danger")}))),t("#title h3").text("开始分组"),t("#title p").text("从第二个待分组人员数据表中选择要分组的人员"))}),t("#datatables2").on("init.dt",function(){t("#mySelect").append('<select class="form-control col-sm-7" id="formSelect">\n                                    <option value="" selected>请选择类别</option>\n                                    <option>本院住院医</option>\n                                    <option>八年制（骨科）</option>\n                                    <option>八年制（非骨科）</option>\n                                    <option>研究生（骨科）</option>\n                                    <option>研究生（非骨科）</option>\n                                    <option>骨科临博</option>\n                                    <option>基地住院医</option>\n                                    <option>进修医</option>\n                                    <option>其他</option>\n                                </select>').css("width","100%").change(function(){var a=t("#formSelect").val();t("#datatables2_filter input").val(a).keyup()})});var v=parseInt(t("#mytab li:last-child a").attr("aria-controls").replace(/[^0-9]/gi,""));t("#nextBtn").click(function(){var a=t(".nav-link.active").attr("aria-controls");a=parseInt(a.replace(/[^0-9]/gi,"")),t("#mytab li:nth-child("+(a>=v?a:a+1)+") a").tab("show")}),t("#backBtn").click(function(){var a=t(".nav-link.active").attr("aria-controls");a=parseInt(a.replace(/[^0-9]/gi,"")),t("#mytab li:nth-child("+(a>1?a-1:a)+") a").tab("show")}),t("#finishBtn").click(function(){t("#datatables_wrapper button").click();var a=JSON.stringify({col:d,data:function(t){for(var a=[],e=0;e<t.length;e++)a.push(t[e]);return a}(l.table.data())});sessionStorage.clear(),sessionStorage.setItem("month",u),sessionStorage.setItem("table",a),window.location.href="/ward.html"}),t('a[data-toggle="tab"]').on("shown.bs.tab",function(a){var e=t(a.target).attr("aria-controls");1===(e=parseInt(e.replace(/[^0-9]/gi,"")))?t("#backBtn").addClass("disabled"):t("#backBtn").removeClass("disabled"),e===v?(t("#nextBtn").css("display","none"),t("#finishBtn").css("display","")):(t("#nextBtn").css("display",""),t("#finishBtn").css("display","none"))});var y=null,h=function(){var t={type:"depart_bak",month:u};t.table=l.table.data().toArray(),t.table2=i.table.data().toArray(),t.table3=c.table.data().toArray(),e.postJson({url:a.backUpUrl,data:JSON.stringify(t)},function(){return a.showNotification("备份成功！","success")},function(){return a.showNotification("备份失败，请检查服务器连接！","danger")})},m=function(){h()},g=function(t){e.getJson({url:a.backUpUrl},function(t){"String"==typeof t&&(t=JSON.parse(t)),t.type&&"depart_bak"===t.type&&t.month===u?(p(t,s),l.updateData(t.table),i.updateData(t.table2),c.updateData(t.table3),a.showNotification("数据恢复成功！","success")):a.showNotification("备份数据与当前选项不符","warning"),y||(y=setInterval(m,6e4),a.showNotification("数据备份已开启，每60s备份一次","info"))},function(){return a.showNotification("恢复失败，请检查服务器连接！","danger")})};t("#backupBtn").click(function(){var t={table:l.table.data().toArray(),table2:i.table.data().toArray(),table3:c.table.data().toArray()},a=new Blob([JSON.stringify(t)],{type:"text/plain;charset=utf-8"});n.saveAs(a,"depart_bak_"+function(){var t=new Date,a=t.getMonth()+1,e=t.getDate();a>=1&&a<=9&&(a="0"+a);e>=0&&e<=9&&(e="0"+e);return t.getFullYear()+"-"+a+"-"+e+"_"+t.getHours()+"-"+t.getMinutes()+"-"+t.getSeconds()}()+".json")}),t("#recoverBtn").change(function(){var e=t("#recoverBtn")[0].files[0],r=new FileReader;r.onload=function(t){var e=t.target.result;p(e=JSON.parse(e),s),l.updateData(e.table),i.updateData(e.table2),c.updateData(e.table3),a.showNotification("数据恢复成功！","success")},r.readAsText(e)}),t("#saveBtn").click(h)});