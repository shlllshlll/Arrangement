"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var a=0,e=new Array(t.length);a<t.length;a++)e[a]=t[a];return e}}define(["jquery","common","module.utils","module.datatable","FileSaver","bootstrap.navtab","module.backup","module.datachecker","datepicker","datepicker.zh-CN"],function(t,a,e,r,n,o,l,i){var c=!1,u=null,d=null,f=null,s=null,b=[],p=null;var v=new l(a.backUpUrl,60,function(){var t={type:"depart_bak",month:s};return t.table=u?u.table.data().toArray():[],t.table2=d?d.table.data().toArray():[],t.table3=f?f.table.data().toArray():[],t},function(t){t.type&&"depart_bak"===t.type&&t.month===s?(w(t,b),u.updateData(t.table),d.updateData(t.table2),f.updateData(t.table3),a.showNotification("数据恢复成功！","success")):a.showNotification("备份数据与当前选项不符","warning")});function m(n,o){var l;1===o?(v.stopBackup(),t("#title h3").text("输入月份"),t("#title p").text("请设置分组的月份")):2===o&&((s=t("#month").val().split("/").join(""))||(s="1810"),!1===c&&(c=!0,l=s,e.getJson({url:a.dataUrl},function(a){"String"==typeof a&&(a=JSON.parse(a)),console.log(a);var n=[],o=!0,i=!1,c=void 0;try{for(var s,m=a.peopledata[Symbol.iterator]();!(o=(s=m.next()).done);o=!0){var y=s.value;-1!==y.month.indexOf(l)&&n.push(y)}}catch(t){i=!0,c=t}finally{try{o||null==m.return||m.return()}finally{if(i)throw c}}var w=[];for(var x in a.departid)w.push(a.departid[x]);var k=w.map(function(t){return{title:t}});p=_toConsumableArray(k),(u=e.getInstance(u,r,["#datatables"])).createTable([],{table:{paging:!1,ordering:!1,columns:p,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"科室分组表",title:null}]}});var A=function(t){var a=(t=parseInt(t))%100,e=Math.floor(t/100);return a<=1?(a=12,e--):a--,(100*e+a).toString()},S=function(t){for(var a=[],e=0;e<8;e++)t=A(t),a.splice(0,0,t);return a}(l),B=S.map(function(t){return{title:t}}),_=[{title:"姓名"},{title:"类别"},{title:"备注"}].concat(_toConsumableArray(B));b=[];for(var O=0,D=n;O<D.length;O++){var N=D[O],j=Array(_.length).fill("");j[0]=N.name,j[1]=N.type,N.remark&&(j[2]=N.remark);var I=!0,C=!1,T=void 0;try{for(var H,J=N.history[Symbol.iterator]();!(I=(H=J.next()).done);I=!0){var M=H.value,W=!0,F=!1,U=void 0;try{for(var z,G=M.month[Symbol.iterator]();!(W=(z=G.next()).done);W=!0){var q=z.value,E=S.indexOf(q);-1!==E&&(j[E+3]=M.name)}}catch(t){F=!0,U=t}finally{try{W||null==G.return||G.return()}finally{if(F)throw U}}}}catch(t){C=!0,T=t}finally{try{I||null==J.return||J.return()}finally{if(C)throw T}}b.push(j)}(d=e.getInstance(d,r,["#datatables2"])).createTable(b,{table:{ordering:!1,autoWidth:!0,columns:_,dom:"<'row'<'col-md-4 d-flex justify-content-start align-items-center'l<'#mySelect'>><'col-md-8 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"带分组人员名单",title:null}]}}),h(d,[3,10]),t("#datatables tbody").on("click","td",function(){if(0!==u.table.data().toArray().length){var t=u.table.cell(this),a=(t.index(),t.data());""!==a&&e.showModal("modal","注意",a+"将被移出科室分组名单，重新退回待分组列表中，是否确定",function(){!function(t,a){var e=t.table.data().toArray(),r=a.index();g(e,r),t.updateData(e)}(u,t);for(var e=f.table.data().toArray(),r=0;r<e.length;r++)if(e[r][0]===a){var n=e.splice(r,1)[0];f.updateData(e);var o=d.table.data().toArray();n.pop(),o.splice(0,0,n),d.updateData(o);break}},"okBtn")}}),t("#datatables2 tbody").on("click","tr",function(){var a=d.table.row(this),r=a.data()[0],n=function(t){var a="",e=!0,r=!1,n=void 0;try{for(var o,l=t[Symbol.iterator]();!(e=(o=l.next()).done);e=!0){var i=o.value;a+='<button type="button" class="btn btn-outline-primary">',a+=i.title,a+="</button>"}}catch(t){r=!0,n=t}finally{try{e||null==l.return||l.return()}finally{if(r)throw n}}return a}(k);e.showModalNoBtn("modal","请选择"+r+"的科室",'<div class="row" id="departBtnGroup">\n                                '.concat(n,"\n                            </div>")),t("#departBtnGroup button").click(function(){if(0!==d.table.data().toArray().length){var e=a.data();a.remove(),d.table.draw(),e.push(t(this).text()),f.table.row.add(e).draw(),u.table.rows().data().length;var n=w.indexOf(t(this).text()),o=(u.table.column(0).data().toArray(),u.table.column(n).data().toArray());if(o.length&&""===o[o.length-1])o.every(function(t,a){return""!==t||(u.table.cell({row:a,column:n}).data(r),!1)});else{var l=Array(p.length).fill("");l[n]=r,u.table.row.add(l).draw()}u.table.draw(),t("#modal").modal("hide")}})});var R=[].concat(_toConsumableArray(_),[{title:l}]);(f=e.getInstance(f,r,["#datatables3"])).createTable([],{table:{ordering:!1,autoWidth:!0,columns:R,dom:"<'row'<'col-md-6'l><'col-md-6 d-flex justify-content-end align-items-center'Bf>><'row'<'col-md-12'tr>><'row'<'col-md-5'i><'col-md-7'p>>",buttons:[{extend:"excelHtml5",filename:"已分组人员名单",title:null}]}}),h(f,[3,10],d.table.columns().data()),v.getData()},function(){return a.showNotification("获取数据失败，请检查服务器连接！","danger")})),v.startBackup(),t("#title h3").text("开始分组"),t("#title p").text("从第二个待分组人员数据表中选择要分组的人员"))}function y(){t("#datatables_wrapper button").click();var a=JSON.stringify({col:p,data:function(t){for(var a=[],e=0;e<t.length;e++)a.push(t[e]);return a}(u.table.data())});sessionStorage.clear(),sessionStorage.setItem("month",s),sessionStorage.setItem("table",a),window.location.href="/ward.html"}function h(t,a){for(var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.table.columns().data(),r=a[0];r<=a[1];r++){var n=e[r],o=!0,l=!0,i=!1,c=void 0;try{for(var u,d=n[Symbol.iterator]();!(l=(u=d.next()).done);l=!0){if(""!==u.value){o=!1;break}}}catch(t){i=!0,c=t}finally{try{l||null==d.return||d.return()}finally{if(i)throw c}}o&&t.table.column(r).visible(!1)}}function g(t,a){if(a.row===t.length-1)t[a.row][a.column]="";else for(var e=a.row+1;e<t.length&&(t[e-1][a.column]=t[e][a.column],""!==t[e][a.column]);e++)t[e][a.column]="";for(var r=t[t.length-1],n=!0,o=0;o<r.length;o++)if(""!==r[o]){n=!1;break}return n&&t.pop(),t}function w(t,a){var e=[],r=!0,n=!1,o=void 0;try{for(var l,i=a[Symbol.iterator]();!(r=(l=i.next()).done);r=!0){var c=l.value;e.push(c[0])}}catch(t){n=!0,o=t}finally{try{r||null==i.return||i.return()}finally{if(n)throw o}}var u=[],d=!0,f=!1,s=void 0;try{for(var b,p=t.table2[Symbol.iterator]();!(d=(b=p.next()).done);d=!0){var v=b.value;u.push(v[0])}}catch(t){f=!0,s=t}finally{try{d||null==p.return||p.return()}finally{if(f)throw s}}var m=!0,y=!1,h=void 0;try{for(var w,x=t.table3[Symbol.iterator]();!(m=(w=x.next()).done);m=!0){var k=w.value;u.push(k[0])}}catch(t){y=!0,h=t}finally{try{m||null==x.return||x.return()}finally{if(y)throw h}}for(var A=0;A<t.table.length;A++)for(var S=0;S<t.table[A].length;S++){var B=t.table[A][S];""!==B&&(-1===e.indexOf(B)&&g(t.table,{row:A,column:S}))}for(var _=0;_<t.table2.length;_++){var O=t.table2[_][0];-1===e.indexOf(O)&&t.table2.splice(_,1)}for(var D=0;D<t.table3.length;D++){var N=t.table3[D][0];-1===e.indexOf(N)&&t.table3.splice(D,1)}for(var j=0;j<t.table2.length;j++){var I=t.table2[j][0],C=e.indexOf(I);-1!==C&&t.table2.splice(j,1,a[C])}for(var T=0;T<t.table3.length;T++){var H=t.table3[T][0],J=e.indexOf(H);-1!==J&&(t.table3[T][1]=a[J][1])}for(var M=0;M<e.length;M++)-1===u.indexOf(e[M])&&t.table2.splice(0,0,a[M]);return t}t("#datatables2").on("init.dt",function(){t("#mySelect").append('<select class="form-control col-sm-7" id="formSelect">\n                                    <option value="" selected>请选择类别</option>\n                                    <option>本院住院医</option>\n                                    <option>八年制（骨科）</option>\n                                    <option>八年制（非骨科）</option>\n                                    <option>研究生（骨科）</option>\n                                    <option>研究生（非骨科）</option>\n                                    <option>骨科临博</option>\n                                    <option>基地住院医</option>\n                                    <option>进修医</option>\n                                    <option>其他</option>\n                                </select>').css("width","100%").change(function(){var a=t("#formSelect").val();t("#datatables2_filter input").val(a).keyup()})}),t("#backupBtn").click(function(){var t={table:u.table.data().toArray(),table2:d.table.data().toArray(),table3:f.table.data().toArray()},a=new Blob([JSON.stringify(t)],{type:"text/plain;charset=utf-8"});n.saveAs(a,"depart_bak_"+function(){var t=new Date,a=t.getMonth()+1,e=t.getDate();a>=1&&a<=9&&(a="0"+a);e>=0&&e<=9&&(e="0"+e);return t.getFullYear()+"-"+a+"-"+e+"_"+t.getHours()+"-"+t.getMinutes()+"-"+t.getSeconds()}()+".json")}),t("#recoverBtn").change(function(){var e=t("#recoverBtn")[0].files[0],r=new FileReader;r.onload=function(t){var e=t.target.result;w(e=JSON.parse(e),b),u.updateData(e.table),d.updateData(e.table2),f.updateData(e.table3),a.showNotification("数据恢复成功！","success")},r.readAsText(e)}),t("#saveBtn").click(function(){v.sendData()}),function(){t('[data-toggle="datepicker"]').datepicker({format:"yy/mm",language:"zh-CN"});var a={1:[{dom:"#month",checker:function(t){return t?null:"日期不能为空"}}],2:[]};new o("#mytab","#nextBtn","#backBtn","#finishBtn",m,y,function(t){return(new i).formDataChecker(a[t])})}()});